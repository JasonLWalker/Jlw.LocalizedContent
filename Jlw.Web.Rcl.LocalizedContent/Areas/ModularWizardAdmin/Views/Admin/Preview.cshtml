@{
    ViewData["Title"] = ViewData["PageTitle"];

    string apiUrl = (string.IsNullOrWhiteSpace(ViewData["apiOverrideUrl"]?.ToString())) ? Url.Action("Index", "Api", new { Area = "ModularWizardAdmin" }) + "/" : ViewData["apiOverrideUrl"]?.ToString();

    string jsRoot = "LocalizedContent";
}

<div class="row h-100">
    <div class="d-none d-lg-inline-block wizard-nav-col col-lg-auto border-right">
        <form method="post">
            <input type="hidden" name="st" value="1" />
            <div class="list-group wizard-nav">
                <button type="button" data-section="0" data-step="0" class="list-group-item list-group-item-action "><span class="fa fa-minus"></span> Instructions</button>
                <button type="button" data-section="1" data-step="1" class="list-group-item list-group-item-action pl-5"><span class="fa fa-minus"></span> Start Wizard</button>
                <button type="button" data-section="4" data-step="0" class="list-group-item list-group-item-action"><span class="fa fa-minus"></span> Review Submission</button>
            </div>
        </form>
    </div>
    <div class="col-md wizard-form">
        <form method="post">
            <div class="h3 wizard-heading">@(ViewData["Heading"] ?? ViewData["Title"])</div>
            <div class="wizard-body">
                <div class="p-0">
                    <div class="h5"><span class="fa fa-exclamation-triangle text-warning"></span>&nbsp;No content loaded, please select a wizard from the toolbar at the left.</div>
                    <input type="hidden" name="step" value="" />
                    <input type="hidden" name="section" value="" />
                </div>
            </div>
            <div class="wizard-buttons row">
            </div>
        </form>
    </div>
</div>
@{
    await Html.RenderPartialAsync("_WizardLibScript");
}
@section Scripts {
    @Html.PartialAsync("~/Areas/ModularWizardAdmin/Views/Admin/_AdminCss.cshtml").Result
    <style>
        html, body, .container, main {
            height: 100%;
        }

        .wizard-form .d-none {
            display: block !important;
            opacity: 0.3;
        }

        .dad-placeholder {
            background-color: #eee;
            border: 2px dashed #aaa;
        }

        .card-body > .row {
            min-height: 2em;
        }

        /*
        div[type=checkbox] {
            position: relative;
            z-index: 1;
            display: inline-block;
            min-height: 0.95rem;
            padding-left: 0.8rem;
            border: 1px solid grey;
            margin-left: -0.7rem;
            margin-bottom: -1px;
        }
        */

        [id^="jlwContainer-"], [id^="jlwElement-"] {
            cursor: pointer;
        }

        .hover-outline {
            outline: 1px dashed darkred;
        }


        [id^='jlwContainer-'].active, [id^='jlwElement-'].active {
            outline: 1px dotted red;
        }

    </style>
    <script src="~/@jsRoot/js/libJlwUtility.min.js"></script>
    <script src="~/@jsRoot/font-awesome/js/fontawesome.min.js"></script>
    <script src="~/@jsRoot/font-awesome/js/solid.min.js"></script>
    <script src="~/@jsRoot/js/toastr.min.js"></script>
    <link rel="stylesheet" href="~/@jsRoot/css/toastr.min.css"></link>
    @Html.PartialAsync("~/Areas/ModularWizardAdmin/Views/Admin/_DragDropScript.cshtml").Result
    <script>
        // Jquery plugin from https://newbedev.com/change-the-tag-but-keep-the-attributes-and-content-jquery-javascript
        (function(a) {
            a.fn.replaceTagName = function(f) {
                var g = [],
                    h = this.length;
                while (h--) {
                    var k = document.createElement(f),
                        b = this[h],
                        d = b.attributes;
                    for (var c = d.length - 1; c >= 0; c--) {
                        var j = d[c];
                        k.setAttribute(j.name, j.value);
                    }
                    k.innerHTML = b.innerHTML;
                    a(b).after(k).remove();
                    g[h - 1] = k;
                }
                return a(g);
            }
        })(window.jQuery);
    </script>
    <script>


        (function(cacheVer) {
            var wizardData = {};
            var dragData = {
                currElem: undefined,
                dragOverElem: undefined,
                height: 0,
                width: 0,
                placeholderElem: undefined
            };

            var libWizard = window.libJlwWizardBase(new window.libJlwUtility() || {},
                window.jQuery,
                {
                    'urlRoot': '@Html.Raw(Url.Action("Index", "Home", new { Area = "" }))',
                    'urlApiRoot': '@apiUrl',
                    'onRenderWizardFormField': onRenderWizardFormField,
                    'onRenderWizardElement': onRenderWizardElement,
                    'onRenderWizard': onRenderWizard,
                    'wizardParent': '.wizard-form'
                }
            );

            function onDragOver(evt) {
                if (dragData.dragOverElem === evt.currentTarget)
                    return;

                var oEvt = evt.originalEvent;
                dragData.dragOverElem = evt.currentTarget;

                oEvt.dataTransfer.dropEffect = 'move';
                $(dragData.placeholderElem).insertAfter($(dragData.dragOverElem));

                //console.log("Dragged over", evt);
            }

            function onRenderWizardFormField(obj, data, parent) {
                var o = $(obj);
                o.data('wizard-data', data);
                
                var cntrl = $('input, button, textarea, select', o);
                cntrl.attr('data-field-type', (data['FieldType']||"").toLowerCase());
                $('input, button, textarea, select', o).replaceTagName('div');


                var p = o.closest('[id^="jlwContainer-"]');
                p.data('wizard-data', data);
                p.off()
                    .on('click', fnOnClickElement)
                    .on('mouseover', fnOnMouseOverElement)
                    .on('mouseout', fnOnMouseOutElement);
                p.data('tree-id', data['Id']);
                p.attr('data-tree-id', data['Id']);

                return obj;
            }

            function onRenderWizardElement(obj, data, parent) {
                var o = $(obj);
                if (o.prop("tagName").toUpperCase() === 'BUTTON') {
                    var id = o.prop('id');
                    o.replaceTagName('div');
                    o = $("#" + id, parent);
                }

                if (o.is("[id^='jlwContainer-'],[id^='jlwElement-']")) {
                    o.off()
                        .on('click', fnOnClickElement)
                        .on('mouseover', fnOnMouseOverElement)
                        .on('mouseout', fnOnMouseOutElement);
                    o.data('wizard-data', data);
                    o.data('tree-id', data['Id']);
                    o.attr('data-tree-id', data['Id']);

                } else {
                    var p = o.parent('[id^="jlwContainer-"]');
                    p.data('wizard-data', data);
                    p.off()
                        .on('click', fnOnClickElement)
                        .on('mouseover', fnOnMouseOverElement)
                        .on('mouseout', fnOnMouseOutElement);
                    p.data('tree-id', data['Id']);
                    p.attr('data-tree-id', data['Id']);
                    //p.attr('draggable', true);
                }
                //console.log(o, data);

                o.attr('data-field-key', data['FieldKey']);
                return o;
            }

            function onRenderWizard(obj, data, parent) {
                var o = $(obj);

                $('.wizard-form').attr('data-field-key', data['FieldKey']);
                $('.wizard-form').attr('data-tree-id', data['Id']);

                var msg = { 'action': 'onRenderWizard' };
                window.parent.postMessage(msg);

                
                return o;
            }

            function fnOnDragDrop(evt, targetElement, origEvent) {
                //console.log(evt, targetElement, origEvent);
                var target = $(evt.currentTarget);
                var nodes = [];
                target.children().each(function(i) {
                    nodes.push($(this).data('tree-id'));
                });
                var msg = { 'action': 'updateOrder', 'nodeIds': nodes, 'fieldKey': $(targetElement).data('tree-id') };
                //console.log(msg);
                window.parent.postMessage(msg);
            }

            function fnOnClickElement(evt) {
                var obj = $(evt.target).closest("[id^='jlwContainer-'],[id^='jlwElement-']");

                if (obj.is("[id^='jlwContainer-'],[id^='jlwElement-']")) {
                    $("[id ^= 'jlwContainer-'], [id ^= 'jlwElement-']").removeClass('active');
                    obj.addClass('active');
                    window.parent.postMessage({ elementData: obj.data('wizard-data'), action: 'click', 'elementId': obj.prop('id') });
                }
            };

            function fnOnMouseOverElement(evt) {
                var o = $(evt.target).closest("[id^='jlwContainer-'],[id^='jlwElement-']");
                o.addClass('hover-outline');
            };

            function fnOnMouseOutElement(evt) {
                var o = $(evt.target).closest("[id^='jlwContainer-'],[id^='jlwElement-']");
                o.removeClass('hover-outline');
            };

            /*
            $('.wizard-buttons').dad({
                exchangeable: false
            });
            $('.wizard-buttons').on('dadDrop', fnOnDragDrop);
            $('.wizard-buttons').on('dadUpdate', function(a, b, c) {
                console.log(a, b, c);
            });
            */
            //$(".wizard-buttons").off('drop.jlwDad').on('drop.jlwDad', fnOnDragDrop);

            window.addEventListener('message',
                function(event) {
                    // IMPORTANT: Check the origin of the data!
                    if (event.origin.indexOf('@String.Format(" {0}://{1}", Context.Request.Scheme, Context.Request.Host)')) {
                        // The data has been sent from your site

                        switch (event.data['action']) {
                        case 'showSideNav':
                            //console.log(event.data);
                            if (event.data['value']) {
                                //console.log('adding side nav');
                                $('.wizard-nav-col').addClass('d-xl-block d-lg-inline-block');
                            } else {
                                //console.log('hiding side nav');
                                $('.wizard-nav-col').addClass('d-none');
                                $('.wizard-nav-col').removeClass('d-xl-block d-lg-inline-block');
                            }

                            break;
                        case 'loadWizard':
                            // The data sent with postMessage is stored in event.data
                            var data = event.data["wizardData"];
                            libWizard.renderWizard(0, 0, data);
                            //var wizardData = data;
                            var nodeData = event.data['nodeData'];
                            var groupKey = nodeData['GroupKey'];
                            var fieldKey = nodeData['FieldKey'];
                            var fieldType = nodeData['FieldType'];
                            var fieldId = nodeData['Id'];
                            var id = (groupKey + '-' + fieldType + '-' + fieldKey + '-' + fieldId).replace(/[^\w\d-_]/i, '');

                            $("[id^='jlwContainer-" + id + "'],[id^='jlwElement-" + id + "']").addClass('active');
                            break;
                        }
                    } else {
                        // The data hasn't been sent from your site!
                        // Be careful! Do not use it.
                        return;
                    }
                });

        })('');
    </script>
}
